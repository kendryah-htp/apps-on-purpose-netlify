<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard — Apps on Purpose™</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0E0A06; color: #FAF6F0; font-family: 'Helvetica Neue', Arial, sans-serif; min-height: 100vh; }

  /* ── Loading ── */
  #loading {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; flex-direction: column; gap: 16px;
  }
  .spinner {
    width: 32px; height: 32px; border: 1px solid rgba(201,169,110,0.2);
    border-top-color: #C9A96E; border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loading p { font-size: 12px; letter-spacing: 0.2em; text-transform: uppercase; color: rgba(201,169,110,0.6); }

  /* ── Not Authorized ── */
  #auth-wall {
    display: none; align-items: center; justify-content: center;
    min-height: 100vh; padding: 40px 20px; text-align: center;
  }
  #auth-wall .inner { max-width: 440px; }
  #auth-wall h2 { font-size: 24px; font-weight: 300; margin-bottom: 16px; color: #FAF6F0; }
  #auth-wall p { font-size: 14px; color: #D4C5B0; line-height: 1.7; margin-bottom: 32px; }
  #auth-wall a.btn { display: inline-block; background: #C9A96E; color: #0E0A06; padding: 14px 36px; text-decoration: none; font-weight: 700; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; }

  /* ── Dashboard ── */
  #dashboard { display: none; }

  .topbar {
    background: #0A0704; border-bottom: 1px solid rgba(201,169,110,0.1);
    padding: 0 32px; height: 60px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .topbar-brand { font-size: 13px; letter-spacing: 0.15em; color: #C9A96E; text-transform: uppercase; }
  .topbar-right { display: flex; align-items: center; gap: 20px; }
  .user-email { font-size: 12px; color: rgba(250,246,240,0.4); }
  .plan-badge { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: #0E0A06; background: #C9A96E; padding: 4px 10px; font-weight: 700; }
  .logout-btn { font-size: 11px; color: rgba(250,246,240,0.3); cursor: pointer; background: none; border: none; letter-spacing: 0.1em; text-transform: uppercase; }
  .logout-btn:hover { color: #C9A96E; }

  .content { max-width: 1000px; margin: 0 auto; padding: 48px 32px; }

  .welcome-bar { margin-bottom: 40px; }
  .welcome-bar h1 { font-size: 28px; font-weight: 300; }
  .welcome-bar h1 em { color: #C9A96E; font-style: italic; }
  .welcome-bar p { font-size: 14px; color: rgba(212,197,176,0.6); margin-top: 8px; }

  .modules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-bottom: 48px; }

  .module-card {
    background: #150F08; border: 1px solid rgba(201,169,110,0.12);
    padding: 28px; cursor: pointer; transition: border-color 0.2s;
    position: relative;
  }
  .module-card:hover { border-color: rgba(201,169,110,0.35); }
  .module-card.locked { opacity: 0.45; cursor: not-allowed; }

  .module-num { font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: rgba(201,169,110,0.5); margin-bottom: 10px; }
  .module-title { font-size: 16px; font-weight: 400; color: #FAF6F0; margin-bottom: 8px; line-height: 1.4; }
  .module-desc { font-size: 13px; color: rgba(212,197,176,0.6); line-height: 1.6; }
  .module-tag { position: absolute; top: 20px; right: 20px; font-size: 9px; letter-spacing: 0.15em; text-transform: uppercase; padding: 3px 8px; }
  .tag-free { background: rgba(201,169,110,0.1); color: #C9A96E; }
  .tag-paid { background: rgba(250,246,240,0.05); color: rgba(250,246,240,0.3); }

  .section-title {
    font-size: 10px; letter-spacing: 0.25em; text-transform: uppercase;
    color: rgba(201,169,110,0.6); margin-bottom: 20px;
    padding-bottom: 12px; border-bottom: 1px solid rgba(201,169,110,0.1);
  }

  .affiliate-box { background: #150F08; border: 1px solid rgba(201,169,110,0.2); padding: 32px; margin-bottom: 48px; }
  .affiliate-box h3 { font-size: 16px; font-weight: 300; margin-bottom: 8px; }
  .affiliate-box p { font-size: 13px; color: rgba(212,197,176,0.6); margin-bottom: 20px; line-height: 1.7; }
  .affiliate-link-box { background: #0E0A06; border: 1px solid rgba(201,169,110,0.1); padding: 14px 18px; font-size: 13px; color: #C9A96E; font-family: monospace; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .copy-btn { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; background: #C9A96E; color: #0E0A06; border: none; padding: 8px 16px; cursor: pointer; font-weight: 700; white-space: nowrap; }
  .copy-btn:active { opacity: 0.8; }

  .resend-link-box { background: #150F08; border: 1px solid rgba(201,169,110,0.1); padding: 24px 28px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
  .resend-link-box p { font-size: 13px; color: rgba(212,197,176,0.6); line-height: 1.6; }
  .resend-btn { font-size: 11px; letter-spacing: 0.15em; text-transform: uppercase; background: none; border: 1px solid rgba(201,169,110,0.3); color: #C9A96E; padding: 10px 20px; cursor: pointer; white-space: nowrap; }
  .resend-btn:hover { border-color: #C9A96E; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="spinner"></div>
  <p>Verifying access…</p>
</div>

<!-- Auth Wall -->
<div id="auth-wall">
  <div class="inner">
    <svg width="48" height="48" viewBox="0 0 64 64" fill="none" style="margin:0 auto 24px;display:block;">
      <path d="M32 4L58 24L32 60L6 24L32 4Z" stroke="#C9A96E" stroke-width="1.5" fill="none" opacity="0.4"/>
      <path d="M32 4L58 24L32 60L6 24L32 4Z" stroke="#C9A96E" stroke-width="1" fill="none"/>
    </svg>
    <h2>Access your dashboard</h2>
    <p>Use the magic link from your welcome email to sign in — no password needed. Check your inbox for an email from <strong style="color:#FAF6F0;">re@elvt.social</strong>.</p>
    <a href="https://aopnow.elvtsocial.xyz" class="btn">← Back to Home</a>
    <p style="margin-top:24px;font-size:12px;color:rgba(250,246,240,0.3);">Lost your link? Email <a href="mailto:support@elvt.social" style="color:#C9A96E;text-decoration:none;">support@elvt.social</a></p>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="topbar">
    <span class="topbar-brand">Apps on Purpose™</span>
    <div class="topbar-right">
      <span class="user-email" id="user-email"></span>
      <span class="plan-badge" id="user-plan">Starter</span>
      <button class="logout-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <div class="content">
    <div class="welcome-bar">
      <h1>Welcome back, <em id="user-name">friend</em>.</h1>
      <p>Pick up where you left off — your dashboard, your pace.</p>
    </div>

    <!-- Modules -->
    <p class="section-title">Course Modules</p>
    <div class="modules-grid">
      <div class="module-card">
        <span class="module-tag tag-free">Start here</span>
        <div class="module-num">Module 01</div>
        <div class="module-title">Foundation & Mindset</div>
        <div class="module-desc">The purpose-driven framework behind every successful app. Why most creators fail and how you won't.</div>
      </div>
      <div class="module-card">
        <div class="module-num">Module 02</div>
        <div class="module-title">Choose Your App Concept</div>
        <div class="module-desc">Use the MakeMyApp GPT to discover your perfect niche in under 2 minutes.</div>
      </div>
      <div class="module-card">
        <div class="module-num">Module 03</div>
        <div class="module-title">Build in Canva</div>
        <div class="module-desc">Step-by-step: design your app inside Canva using our proven templates and structure.</div>
      </div>
      <div class="module-card">
        <div class="module-num">Module 04</div>
        <div class="module-title">Package & Price</div>
        <div class="module-desc">How to position, name, and price your app so it sells. The packaging psychology that converts.</div>
      </div>
      <div class="module-card">
        <div class="module-num">Module 05</div>
        <div class="module-title">Launch Strategy</div>
        <div class="module-desc">Your 5-day pre-launch sequence. Content, emails, and DM scripts that drive first sales.</div>
      </div>
      <div class="module-card">
        <div class="module-num">Module 06</div>
        <div class="module-title">Affiliate System Setup</div>
        <div class="module-desc">Set up your own affiliate program so others sell for you. Automation included.</div>
      </div>
      <div class="module-card">
        <div class="module-num">Module 07</div>
        <div class="module-title">Scale & Systemize</div>
        <div class="module-desc">Turn one app into a suite. Build the ecosystem that generates income while you sleep.</div>
      </div>
    </div>

    <!-- Affiliate Hub -->
    <p class="section-title">Affiliate Hub</p>
    <div class="affiliate-box">
      <h3>Your affiliate link ✦</h3>
      <p>Share your link and earn 50% recurring commission on every Starter and Creator sale — paid monthly via Stripe.</p>
      <div class="affiliate-link-box">
        <span id="affiliate-link">https://aopnow.elvtsocial.xyz/?ref=loading</span>
        <button class="copy-btn" onclick="copyAffLink()">Copy Link</button>
      </div>
    </div>

    <!-- Resend magic link -->
    <p class="section-title">Account</p>
    <div class="resend-link-box">
      <p>Next time you need to log in, just email us and we'll send a fresh magic link within minutes — or request one automatically below.</p>
      <button class="resend-btn" onclick="requestNewLink()">Email Me a New Link</button>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL  = 'https://jajtyudbkyrqklbnaggm.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imphant5dWRia3lycWtsYm5hZ2dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDc0NzgzMzIsImV4cCI6MjAyMzA1NDMzMn0.OONkgs';

  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  async function init() {
    // Handle magic link token in URL (Supabase puts it in hash)
    const { data: { session }, error } = await sb.auth.getSession();

    if (session?.user) {
      showDashboard(session.user);
    } else {
      // Check for magic link in URL hash
      const hash = window.location.hash;
      if (hash.includes('access_token') || hash.includes('type=magiclink') || new URLSearchParams(window.location.search).get('code')) {
        // Let Supabase handle the exchange
        const { data, error: exchangeError } = await sb.auth.exchangeCodeForSession(
          new URLSearchParams(window.location.search).get('code') || ''
        ).catch(() => ({ data: null, error: true }));

        // Re-check session after exchange attempt
        const { data: { session: newSession } } = await sb.auth.getSession();
        if (newSession?.user) {
          showDashboard(newSession.user);
          return;
        }
      }

      // No session
      showAuthWall();
    }
  }

  function showDashboard(user) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';

    const email    = user.email || '';
    const meta     = user.user_metadata || {};
    const name     = (meta.full_name || email.split('@')[0] || 'friend').split(' ')[0];
    const plan     = meta.plan || 'Starter';
    const affId    = email.split('@')[0].replace(/[^a-z0-9]/gi, '').toLowerCase();

    document.getElementById('user-email').textContent  = email;
    document.getElementById('user-plan').textContent   = plan;
    document.getElementById('user-name').textContent   = name;
    document.getElementById('affiliate-link').textContent = `https://aopnow.elvtsocial.xyz/?ref=${affId}`;

    // Clean URL
    window.history.replaceState({}, '', '/dashboard');
  }

  function showAuthWall() {
    document.getElementById('loading').style.display  = 'none';
    document.getElementById('auth-wall').style.display = 'flex';
  }

  function copyAffLink() {
    const link = document.getElementById('affiliate-link').textContent;
    navigator.clipboard.writeText(link).then(() => {
      const btn = document.querySelector('.copy-btn');
      btn.textContent = 'Copied ✓';
      setTimeout(() => btn.textContent = 'Copy Link', 2000);
    });
  }

  async function signOut() {
    await sb.auth.signOut();
    window.location.href = '/';
  }

  async function requestNewLink() {
    const email = document.getElementById('user-email').textContent;
    if (!email) return;
    const btn = document.querySelector('.resend-btn');
    btn.textContent = 'Sending…';
    btn.disabled = true;
    const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: 'https://aopnow.elvtsocial.xyz/dashboard' } });
    btn.textContent = error ? 'Error — try again' : 'Sent! Check your inbox ✓';
    setTimeout(() => { btn.textContent = 'Email Me a New Link'; btn.disabled = false; }, 4000);
  }

  // Supabase handles the magic link token automatically on load
  sb.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session?.user) {
      showDashboard(session.user);
    }
  });

  init();
</script>
</body>
</html>
