<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Set Your Password — Apps on Purpose™</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0E0A06;
    color: #FAF6F0;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
  }
  .card {
    max-width: 420px;
    width: 100%;
    background: #150F08;
    border: 1px solid rgba(201,169,110,0.15);
    padding: 48px 40px;
  }
  .logo {
    text-align: center;
    margin-bottom: 36px;
  }
  .eyebrow {
    font-size: 10px;
    letter-spacing: 0.28em;
    text-transform: uppercase;
    color: #C9A96E;
    display: block;
    margin-bottom: 8px;
  }
  h1 {
    font-size: 26px;
    font-weight: 300;
    color: #FAF6F0;
  }
  h1 em { color: #C9A96E; font-style: italic; }
  .title {
    font-size: 18px;
    font-weight: 300;
    color: #FAF6F0;
    margin-bottom: 8px;
  }
  .subtitle {
    font-size: 13px;
    color: rgba(212,197,176,0.6);
    line-height: 1.6;
    margin-bottom: 32px;
  }
  .divider {
    height: 1px;
    background: rgba(201,169,110,0.1);
    margin-bottom: 32px;
  }
  label {
    display: block;
    font-size: 10px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(250,246,240,0.4);
    margin-bottom: 8px;
  }
  input[type="password"] {
    width: 100%;
    background: #0E0A06;
    border: 1px solid rgba(201,169,110,0.2);
    color: #FAF6F0;
    padding: 14px 16px;
    font-size: 15px;
    font-family: inherit;
    outline: none;
    transition: border 0.2s;
    margin-bottom: 20px;
  }
  input[type="password"]:focus {
    border-color: #C9A96E;
  }
  .strength {
    display: flex;
    gap: 4px;
    margin-top: -14px;
    margin-bottom: 20px;
  }
  .strength-bar {
    height: 3px;
    flex: 1;
    background: rgba(201,169,110,0.15);
    transition: background 0.3s;
  }
  .btn {
    width: 100%;
    background: #C9A96E;
    color: #0E0A06;
    border: none;
    padding: 16px;
    font-size: 11px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.2s;
  }
  .btn:hover:not(:disabled) { background: #D4B87A; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .error {
    background: rgba(220,50,50,0.1);
    border: 1px solid rgba(220,50,50,0.3);
    color: #ff6b6b;
    padding: 12px 16px;
    font-size: 13px;
    margin-bottom: 20px;
    display: none;
  }
  .success-state {
    text-align: center;
    display: none;
  }
  .success-state .check {
    width: 56px;
    height: 56px;
    border: 2px solid #C9A96E;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 22px;
  }
  .success-state h2 {
    font-size: 22px;
    font-weight: 300;
    color: #FAF6F0;
    margin-bottom: 12px;
  }
  .success-state p {
    font-size: 14px;
    color: #D4C5B0;
    line-height: 1.7;
    margin-bottom: 28px;
  }
  .go-btn {
    display: block;
    background: #C9A96E;
    color: #0E0A06;
    padding: 16px;
    text-decoration: none;
    font-size: 11px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    font-weight: 700;
    text-align: center;
  }
  .loading { opacity: 0.6; }
  .hint {
    font-size: 12px;
    color: rgba(250,246,240,0.25);
    margin-top: 16px;
    text-align: center;
  }
  .hint a { color: rgba(201,169,110,0.5); text-decoration: none; }
</style>
</head>
<body>
<div class="card">
  <div class="logo">
    <span class="eyebrow">ELVT Social</span>
    <h1>Apps <em>on Purpose</em>™</h1>
  </div>

  <div id="formState">
    <div class="divider"></div>
    <p class="title">Set your password</p>
    <p class="subtitle">Choose a password to access your dashboard. Must be at least 8 characters.</p>

    <div class="error" id="errorMsg"></div>

    <label>New Password</label>
    <input type="password" id="password" placeholder="Min. 8 characters" oninput="checkStrength()">

    <div class="strength">
      <div class="strength-bar" id="s1"></div>
      <div class="strength-bar" id="s2"></div>
      <div class="strength-bar" id="s3"></div>
      <div class="strength-bar" id="s4"></div>
    </div>

    <label>Confirm Password</label>
    <input type="password" id="confirm" placeholder="Re-enter password">

    <button class="btn" id="submitBtn" onclick="setPassword()">Set Password & Enter →</button>
    <p class="hint">Already have a password? <a href="/login">Log in here</a></p>
  </div>

  <div class="success-state" id="successState">
    <div class="check">✦</div>
    <h2>Password set!</h2>
    <p>Your account is ready. Click below to log in and start building.</p>
    <a href="/login" class="go-btn">Go to Dashboard →</a>
  </div>
</div>

<script>
  // Extract token from URL (Supabase puts it in the hash or query)
  function getToken() {
    // Check hash fragment (Supabase default)
    const hash = window.location.hash;
    if (hash) {
      const params = new URLSearchParams(hash.replace('#', ''));
      const accessToken = params.get('access_token');
      if (accessToken) return { token: accessToken, type: 'access' };
    }
    // Check query string
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    if (token) return { token, type: 'recovery' };
    return null;
  }

  function checkStrength() {
    const pw = document.getElementById('password').value;
    const bars = [s1, s2, s3, s4];
    let strength = 0;
    if (pw.length >= 8) strength++;
    if (pw.length >= 12) strength++;
    if (/[A-Z]/.test(pw) && /[0-9]/.test(pw)) strength++;
    if (/[^A-Za-z0-9]/.test(pw)) strength++;

    const colors = ['#ef4444', '#f97316', '#C9A96E', '#4ade80'];
    bars.forEach((bar, i) => {
      bar.style.background = i < strength ? colors[strength - 1] : 'rgba(201,169,110,0.15)';
    });
  }

  async function setPassword() {
    const password = document.getElementById('password').value;
    const confirm = document.getElementById('confirm').value;
    const btn = document.getElementById('submitBtn');
    const errorEl = document.getElementById('errorMsg');

    errorEl.style.display = 'none';

    if (!password || password.length < 8) {
      showError('Password must be at least 8 characters.');
      return;
    }
    if (password !== confirm) {
      showError('Passwords don\'t match. Please try again.');
      return;
    }

    const tokenData = getToken();
    if (!tokenData) {
      showError('Invalid or expired link. Please contact support@elvt.social for a new link.');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Setting password...';

    try {
      // Use Supabase client-side to update password with the token
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
      const supabase = createClient(
        'https://jajtyudbkyrqklbnаggm.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImphZ3R5dWRia3lycWtsYm5hZ2dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDk5MzM2MDAsImV4cCI6MjAyNTUwOTYwMH0.placeholder'
      );

      let result;
      if (tokenData.type === 'access') {
        // Set the session from the access token in the URL hash
        await supabase.auth.setSession({
          access_token: tokenData.token,
          refresh_token: new URLSearchParams(window.location.hash.replace('#', '')).get('refresh_token')
        });
        result = await supabase.auth.updateUser({ password });
      } else {
        // Exchange recovery token
        await supabase.auth.exchangeCodeForSession(tokenData.token);
        result = await supabase.auth.updateUser({ password });
      }

      if (result.error) throw new Error(result.error.message);

      // Success
      document.getElementById('formState').style.display = 'none';
      document.getElementById('successState').style.display = 'block';

    } catch (err) {
      showError(err.message || 'Something went wrong. Please contact support@elvt.social');
      btn.disabled = false;
      btn.textContent = 'Set Password & Enter →';
    }
  }

  function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.style.display = 'block';
  }
</script>
</body>
</html>
